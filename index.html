<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aero Fighters Saga v18.0 (Boss Fix)</title>
    <style>
        body {
            margin: 0; background-color: #111;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; user-select: none; touch-action: none;
        }
        #game-container {
            position: relative; width: 100%; max-width: 450px; height: 100%; max-height: 800px;
            border: 2px solid #333; background-color: #000; box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; pointer-events: none; z-index: 10; }
        .top-bar { display: flex; justify-content: space-between; width: 100%; }
        .stat-box { text-shadow: 2px 2px 0 #000; font-weight: bold; font-size: 18px; font-family: monospace; }
        #score-text { color: #ffff00; } #lives-text { color: #ff3333; } #level-text { color: #00ff00; }
        
        .power-bar-container { margin-top: 5px; width: 100%; height: 10px; background: #333; border: 1px solid white; position: relative; }
        #super-bar-fill { width: 0%; height: 100%; background: cyan; box-shadow: 0 0 10px cyan; transition: width 0.1s; }
        #super-text { position: absolute; top: -15px; left: 0; font-size: 12px; color: cyan; font-weight: bold; }

        #boss-hud { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 80%; display: none; z-index: 10; }
        #boss-label { text-align: center; font-weight: bold; color: magenta; text-shadow: 1px 1px black; margin-bottom: 5px; }
        #boss-health-bar { width: 100%; height: 15px; background-color: #333; border: 2px solid white; }
        #boss-health-fill { width: 100%; height: 100%; background-color: #ff0055; transition: width 0.1s; }

        /* Mobile Controls */
        #mobile-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%; height: 180px;
            pointer-events: none; z-index: 20; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
        }
        .control-group { pointer-events: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .dpad-row { display: flex; }
        .btn-dir { width: 60px; height: 60px; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 10px; margin: 5px; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; }
        .action-group { position: relative; width: 140px; height: 140px; }
        #btn-fire { position: absolute; bottom: 0; right: 0; width: 90px; height: 90px; background: rgba(255, 0, 0, 0.3); border: 2px solid rgba(255, 0, 0, 0.5); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; }
        #btn-super { position: absolute; top: 0; left: 0; width: 60px; height: 60px; background: rgba(0, 255, 255, 0.3); border: 2px solid rgba(0, 255, 255, 0.5); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 14px; }

        /* Menu */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        h1 { font-size: 36px; color: #00ccff; margin: 0 0 10px 0; text-shadow: 0 0 20px #00ccff; }
        button { margin-top: 20px; padding: 15px 40px; font-size: 22px; cursor: pointer; background: #00ccff; color: black; border: none; border-radius: 5px; font-weight: bold; pointer-events: auto; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="450" height="650"></canvas>
        <div id="ui-layer">
            <div class="top-bar">
                <div id="lives-text" class="stat-box">HP: <span id="lives-val">3</span></div>
                <div id="level-text" class="stat-box">FASE: <span id="level-val">1</span></div>
                <div id="score-text" class="stat-box">PTS: <span id="score-val">0</span></div>
            </div>
            <div class="power-bar-container"><div id="super-text">SUPER (Z)</div><div id="super-bar-fill"></div></div>
        </div>
        <div id="boss-hud"><div id="boss-label">⚠️ ALERTA DE CHEFÃO ⚠️</div><div id="boss-health-bar"><div id="boss-health-fill"></div></div></div>
        <div id="mobile-controls">
            <div class="control-group">
                <div class="dpad-row"><div class="btn-dir" id="btn-up" data-key="ArrowUp">▲</div></div>
                <div class="dpad-row"><div class="btn-dir" id="btn-left" data-key="ArrowLeft">◀</div><div class="btn-dir" id="btn-down" data-key="ArrowDown">▼</div><div class="btn-dir" id="btn-right" data-key="ArrowRight">▶</div></div>
            </div>
            <div class="control-group action-group"><div id="btn-super" data-key="KeyZ">Z</div><div id="btn-fire" data-key="Space">TIRO</div></div>
        </div>
        <div id="menu-screen">
            <h1>AERO SAGA</h1>
            <p>Desktop: WASD | Mobile: Toque</p>
            <button id="start-btn">INICIAR MISSÃO</button>
        </div>
    </div>

    <script>
        // IMAGENS E SONS
        const images = {};
        const imageList = {
            'p1': 'p1.png', 'p2': 'p2.png', 'p3': 'p3.png', 'p4': 'p4.png', 'p5': 'p5.png',
            'enemies': 'enemies.png', 'bosses': 'bosses.png'
        };
        for (let key in imageList) { images[key] = new Image(); images[key].src = imageList[key]; }

        const sounds = {
            shoot: new Audio('shoot.mp3'), explosion: new Audio('explosion.mp3'),
            powerup: new Audio('powerup.mp3'), bgm: new Audio('bgm.mp3')
        };
        sounds.bgm.loop = true; sounds.bgm.volume = 0.4;
        
        function playSound(name) {
            if(name==='bgm'){ sounds.bgm.play().catch(()=>{}); return; }
            const s = sounds[name].cloneNode(); s.volume = sounds[name].volume; s.play().catch(()=>{});
        }
        function stopMusic() { sounds.bgm.pause(); sounds.bgm.currentTime = 0; }

        // SETUP
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resizeCanvas() { 
            const c = document.getElementById('game-container'); 
            canvas.width = c.clientWidth; canvas.height = c.clientHeight; 
        }
        window.addEventListener('resize', resizeCanvas);
        window.onload = function() {
            resizeCanvas();
            document.getElementById('start-btn').onclick = function() { startGame(); };
            document.querySelectorAll('.btn-dir, #btn-fire, #btn-super').forEach(btn => {
                const k = btn.getAttribute('data-key');
                btn.addEventListener('touchstart', (e)=>{e.preventDefault(); keys[k]=true; btn.style.opacity=0.5}, {passive:false});
                btn.addEventListener('touchend', (e)=>{e.preventDefault(); keys[k]=false; btn.style.opacity=1}, {passive:false});
                btn.addEventListener('mousedown', ()=>{keys[k]=true}); btn.addEventListener('mouseup', ()=>{keys[k]=false});
            });
            setInterval(() => { if(!gameRunning) draw(); }, 50);
        };

        // GAME VARS
        const uiLives=document.getElementById('lives-val'), uiScore=document.getElementById('score-val'), uiLevel=document.getElementById('level-val'), uiSuper=document.getElementById('super-bar-fill');
        const bossHud=document.getElementById('boss-hud'), bossFill=document.getElementById('boss-health-fill'), menuScreen=document.getElementById('menu-screen');
        
        let gameRunning = false, score = 0, frames = 0, currentStage = 1;
        const keys = {}; window.addEventListener('keydown', e=>keys[e.code]=true); window.addEventListener('keyup', e=>keys[e.code]=false);
        
        let particles=[], bullets=[], enemies=[], enemyBullets=[], powerUps=[], boss=null, shockwaves=[], player={};

        const stageThemes = [
            {bg:'#000000', star:'white', en:'#ff3333'}, {bg:'#87CEEB', star:'white', en:'#006400'},
            {bg:'#000033', star:'#4444ff', en:'#00ffff'}, {bg:'#3b1010', star:'#ffaaaa', en:'#ffa500'},
            {bg:'#001100', star:'#00ff00', en:'#ccffcc'}, {bg:'#1a001a', star:'#ff00ff', en:'#ffff00'}
        ];

        function startGame() {
            menuScreen.classList.add('hidden'); currentStage = 1; score = 0;
            playSound('bgm'); resetLevel(true);
            if(!gameRunning) { gameRunning=true; loop(); }
        }

        function resetLevel(full) {
            particles=[]; 
            for(let i=0;i<60;i++) particles.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2+1, sp:Math.random()*3+1});
            
            if(full) player = {x:canvas.width/2-20, y:canvas.height-100, w:45, h:55, speed:5, hp:3, maxHp:3, inv:0, pl:1, evo:0, sc:0, tr:true, bc:0, bt:0, fc:0};
            else { player.x=canvas.width/2-20; player.y=canvas.height-100; player.inv=100; }
            
            bullets=[]; enemies=[]; enemyBullets=[]; powerUps=[]; boss=null; shockwaves=[];
            bossHud.style.display='none'; frames=0; updateUI();
        }

        function updateUI() {
            uiScore.innerText=score; uiLives.innerText=player.hp; uiLevel.innerText=currentStage; uiSuper.style.width=player.sc+'%';
        }

        function update() {
            if(!gameRunning) return; frames++;
            
            // BG
            particles.forEach(p=>{ p.y+=p.sp; if(p.y>canvas.height) p.y=-10; });

            // Player
            if((keys['ArrowLeft']||keys['KeyA']) && player.x>0) player.x-=player.speed;
            if((keys['ArrowRight']||keys['KeyD']) && player.x<canvas.width-player.w) player.x+=player.speed;
            if((keys['ArrowUp']||keys['KeyW']) && player.y>0) player.y-=player.speed;
            if((keys['ArrowDown']||keys['KeyS']) && player.y<canvas.height-player.h) player.y+=player.speed;
            if(player.inv>0) player.inv--;

            // Shoot
            if(player.bt>0) player.bt--; if(player.fc>0) player.fc--;
            if(keys['KeyZ'] && player.sc>=100) { player.sc=0; shockwaves.push({x:player.x+player.w/2,y:player.y,r:10}); playSound('explosion'); }
            
            if(!keys['Space']) { player.tr=true; if(player.bt===0) player.bc=0; }
            else {
                if(player.pl<3) { if(player.tr) { fire(); player.tr=false; } }
                else if(player.bt===0 && player.fc===0) {
                    fire(); player.bc++; player.fc=5;
                    if(player.bc>=5) { player.bt=50; player.bc=0; }
                }
            }

            // Logic
            bullets.forEach((b,i)=>{ b.y-=10; if(b.y<-20) bullets.splice(i,1); });
            enemyBullets.forEach((b,i)=>{ b.x+=b.vx; b.y+=b.vy; if(b.y>canvas.height) enemyBullets.splice(i,1); });
            shockwaves.forEach((s,i)=>{ 
                s.r+=15; if(s.r>800) shockwaves.splice(i,1); 
                enemies.forEach((e,j)=>{ if(dist(s.x,s.y,e.x,e.y)<s.r) { enemies.splice(j,1); score+=20; playSound('explosion'); }});
                enemyBullets=[];
                if(boss && dist(s.x,s.y,boss.x,boss.y)<s.r) { boss.hp-=2; boss.ht=2; playSound('explosion'); }
            });

            // Spawns
            if(!boss && score < currentStage*800) {
                if(frames%(60-currentStage*5)===0) enemies.push({x:Math.random()*(canvas.width-40)+20, y:-40, w:40, h:40, hp:currentStage, t:(currentStage-1)%4});
            } else if(!boss && enemies.length===0 && score>=currentStage*800) {
                boss = {x:canvas.width/2, y:-150, w:120, h:100, hp:60*currentStage, max:60*currentStage, dx:2, st:'enter', ht:0, t:(currentStage-1)%6}; // Modulo 6 para 6 chefes
                bossHud.style.display='block';
            }

            // Collisions
            enemies.forEach((e,i)=>{
                e.y+=2+currentStage*0.5;
                bullets.forEach((b,j)=>{
                    if(dist(b.x,b.y,e.x,e.y)<e.w/2+5) {
                        e.hp--; bullets.splice(j,1);
                        if(e.hp<=0) { 
                            if(Math.random()<0.2) powerUps.push({x:e.x,y:e.y});
                            enemies.splice(i,1); score+=10*currentStage; player.sc=Math.min(100,player.sc+10); playSound('explosion');
                        }
                    }
                });
                if(dist(player.x+player.w/2,player.y+player.h/2,e.x,e.y)<30) hitPlayer();
                if(e.y>canvas.height) enemies.splice(i,1);
            });

            if(boss) {
                if(boss.ht>0) boss.ht--;
                if(boss.st==='enter') { boss.y++; if(boss.y>100) boss.st='fight'; }
                else {
                    boss.x+=boss.dx; if(boss.x<60||boss.x>canvas.width-60) boss.dx*=-1;
                    if(frames%40===0) enemyBullets.push({x:boss.x, y:boss.y+50, vx:(Math.random()-0.5)*5, vy:5});
                }
                bullets.forEach((b,i)=>{
                    if(dist(b.x,b.y,boss.x,boss.y)<60) {
                        boss.hp--; boss.ht=2; bullets.splice(i,1);
                        bossFill.style.width=(boss.hp/boss.max*100)+'%';
                        if(boss.hp<=0) { 
                            playSound('explosion'); player.evo++; player.maxHp++; player.hp=player.maxHp;
                            if(currentStage<6) { 
                                gameRunning=false; 
                                document.querySelector('#menu-screen h1').innerText="FASE "+currentStage+" COMPLETA";
                                document.querySelector('#menu-screen button').innerText="PRÓXIMA FASE";
                                document.querySelector('#menu-screen button').onclick = ()=>{ currentStage++; menuScreen.classList.add('hidden'); resetLevel(false); gameRunning=true; loop(); };
                                menuScreen.classList.remove('hidden');
                            } else { victory(); }
                        }
                    }
                });
            }

            enemyBullets.forEach((b,i)=>{ if(dist(player.x+20,player.y+25,b.x,b.y)<20) hitPlayer(); });
            powerUps.forEach((p,i)=>{ 
                p.y+=3; 
                if(dist(player.x+20,player.y+25,p.x,p.y)<30) { 
                    player.pl=Math.min(4,player.pl+1); score+=50; powerUps.splice(i,1); playSound('powerup');
                }
            });
            updateUI();
        }

        function fire() {
            playSound('shoot');
            let x=player.x+player.w/2, y=player.y, c='#ff0';
            if(player.pl===1) bullets.push({x:x, y:y, w:5, h:12, c:c});
            else if(player.pl===2) { bullets.push({x:x-15, y:y, w:5, h:12, c:c}); bullets.push({x:x+15, y:y, w:5, h:12, c:c}); }
            else if(player.pl===3) { bullets.push({x:x,y:y,w:5,h:12,c:c}); bullets.push({x:x-15,y:y+5,w:4,h:10,c:c}); bullets.push({x:x+15,y:y+5,w:4,h:10,c:c}); }
            else { bullets.push({x:x,y:y,w:6,h:15,c:'cyan'}); bullets.push({x:x-15,y:y+5,w:4,h:10,c:c}); bullets.push({x:x+15,y:y+5,w:4,h:10,c:c}); bullets.push({x:x-30,y:y+10,w:4,h:10,c:c}); bullets.push({x:x+30,y:y+10,w:4,h:10,c:c}); }
        }

        function hitPlayer() {
            if(player.inv>0) return;
            player.hp--; player.inv=60; player.pl=Math.max(1,player.pl-1); playSound('explosion');
            if(player.hp<=0) { gameRunning=false; stopMusic(); document.querySelector('#menu-screen h1').innerText="GAME OVER"; document.querySelector('#menu-screen button').innerText="REINICIAR"; document.querySelector('#menu-screen button').onclick=()=>startGame(); menuScreen.classList.remove('hidden'); }
        }

        function victory() {
            gameRunning=false; stopMusic(); document.querySelector('#menu-screen h1').innerText="JOGO ZERADO!"; document.querySelector('#menu-screen button').innerText="JOGAR DE NOVO"; document.querySelector('#menu-screen button').onclick=()=>startGame(); menuScreen.classList.remove('hidden');
        }

        function dist(x1,y1,x2,y2) { return Math.sqrt((x2-x1)**2+(y2-y1)**2); }

        function draw() {
            let theme = stageThemes[currentStage-1];
            ctx.fillStyle = theme.bg; ctx.fillRect(0,0,canvas.width,canvas.height);
            particles.forEach(p=>{ ctx.fillStyle=theme.star; ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill(); });
            
            if(!gameRunning) return;
            
            if(player.inv%10<5) {
                let img = images['p'+(Math.min(player.evo+1,5))];
                if(img.complete) ctx.drawImage(img, player.x, player.y, player.w, player.h);
                else { ctx.fillStyle='#0cf'; ctx.fillRect(player.x, player.y, player.w, player.h); }
            }

            enemies.forEach(e=>{
                let img = images['enemies'];
                if(img.complete) {
                    let sw=img.width/2, sh=img.height/2;
                    let col=e.t%2, row=Math.floor(e.t/2);
                    ctx.drawImage(img, col*sw, row*sh, sw, sh, e.x-e.w/2, e.y-e.h/2, e.w, e.h);
                } else { ctx.fillStyle=theme.en; ctx.fillRect(e.x-e.w/2, e.y-e.h/2, e.w, e.h); }
            });

            if(boss) {
                let img = images['bosses'];
                if(boss.ht>0) ctx.globalCompositeOperation='lighter';
                if(img.complete) {
                    // CORREÇÃO: 3 Colunas x 2 Linhas = 6 Naves
                    let cols=3, rows=2;
                    let sw=img.width/cols, sh=img.height/rows;
                    let col=boss.t%cols, row=Math.floor(boss.t/cols);
                    ctx.drawImage(img, col*sw, row*sh, sw, sh, boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h);
                } else { ctx.fillStyle=theme.en; ctx.fillRect(boss.x-boss.w/2, boss.y-boss.h/2, boss.w, boss.h); }
                ctx.globalCompositeOperation='source-over';
            }

            powerUps.forEach(p=>{ ctx.fillStyle='#0f0'; ctx.fillRect(p.x-10,p.y-10,20,20); ctx.fillStyle='#000'; ctx.fillText('P',p.x-5,p.y+5); });
            bullets.forEach(b=>{ ctx.fillStyle=b.c; ctx.fillRect(b.x-b.w/2,b.y,b.w,b.h); });
            enemyBullets.forEach(b=>{ ctx.fillStyle='#f00'; ctx.beginPath(); ctx.arc(b.x,b.y,6,0,Math.PI*2); ctx.fill(); });
            shockwaves.forEach(s=>{ ctx.strokeStyle='cyan'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.stroke(); });
        }

        function loop() { update(); draw(); if(gameRunning) requestAnimationFrame(loop); }
    </script>
</body>
</html>